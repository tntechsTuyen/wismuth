<!DOCTYPE html>
<html>
<head>
	<title></title>
    <title>TennisElotool</title>
	<link rel="stylesheet" type="text/css" href="css/app.min.css">
	<link rel="stylesheet" type="text/css" href="css/vendor.min.css">
	<link rel="stylesheet" type="text/css" href="css/style.min.css">
	<link rel="stylesheet" type="text/css" href="plugins/jquery-ui/css/jquery-ui.css">
	<script src="plugins/jquery/jquery.min.js"></script>
	<script src="plugins/jquery-ui/js/jquery-ui.js"></script>
    <script src="js/rest.min.js"></script>
	<script>
		var dataset = {
            tab1:{
                tennis: {
                    man: null,
                    woman: null
                },
                player: {
                    "p_1": {},
                    "p_2": {}
                },
                tennisM: {}
            },
            tab2:{
                matches: {},
                matchmx: {
                    man: [],
                    woman: []
                },
                crank: {
                    man: {},
                    woman: {}
                },
                player: {
                    p_1: {},
                    p_2: {}
                }
            }
		}
	</script>
	<script src="https://www.minorleaguesplits.com/tennisabstract/cgi-bin/jsmatches/leadersource.js"></script>
	<script>
		dataset.tab2.matchmx.man.push(...matchmx)
		dataset.tab2.crank.man = {...dataset.tab2.crank.man, ...crank}
	</script>
	<script src="https://www.minorleaguesplits.com/tennisabstract/cgi-bin/jsmatches/leadersource51.js"></script>
	<script>
		dataset.tab2.matchmx.man.push(...matchmx)
		dataset.tab2.crank.man = {...dataset.tab2.crank.man, ...crank}
	</script>
	<script src="https://www.minorleaguesplits.com/tennisabstract/cgi-bin/jsmatches/leadersource_wta.js"></script>
	<script>
		dataset.tab2.matchmx.woman.push(...matchmx)
		dataset.tab2.crank.woman = {...dataset.tab2.crank.woman, ...crank}
	</script>
	<script src="https://www.minorleaguesplits.com/tennisabstract/cgi-bin/jsmatches/leadersource51_wta.js"></script>
	<script>
		dataset.tab2.matchmx.woman.push(...matchmx)
		dataset.tab2.crank.woman = {...dataset.tab2.crank.woman, ...crank}
	</script>
</head>
<body>
    <div id="menu-hide"></div>
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a href="#default-tab-1" data-bs-toggle="tab" class="nav-link active">
                <span class="d-sm-none">Tab 1</span>
                <span class="d-sm-block d-none">Default Tab 1</span>
            </a>
        </li>
        <li class="nav-item">
            <a href="#default-tab-2" data-bs-toggle="tab" class="nav-link">
                <span class="d-sm-none">Tab 2</span>
                <span class="d-sm-block d-none">Default Tab 2</span>
            </a>
        </li>
    </ul>
    <div class="tab-content panel p-3 rounded-0 rounded-bottom" style="background: #f2f3f4">
        <div class="tab-pane fade active show" id="default-tab-1">
            <main class="m-2">
                <div class="row">
                    <label class="form-label col-form-label col-2">Gender</label>
                    <div class="col-3 pt-2">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" id="gender11" name="gender1" value="man" checked>
                            <label class="form-check-label" for="gender11">Man</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" id="gender12" name="gender1" value="woman">
                            <label class="form-check-label" for="gender12">Woman</label>
                        </div>
                    </div>
                </div>

                <div class="row mt-2">
                    <div class="col-6">
                        <div class="panel panel-inverse">
                            <div class="panel-heading">
                                <h4 class="panel-title">Player information</h4>
                                <div class="panel-heading-btn">
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-success" data-toggle="panel-reload" ><i class="fa fa-redo"></i></a>
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse" ><i class="fa fa-minus"></i></a>
                                </div>
                            </div>
                            <div class="panel-body">
                                <!-- Player 1 -->
                                <div class="row">
                                    <!-- Player 1 -->
                                    <div class="col-6">
                                        <div class="form-floating">
                                            <input id="player_1" name="player_name" class="form-control fs-15px"/>
                                            <label for="player_1" class="d-flex align-items-center fs-13px">Player 1<span class="text-danger ms-1">*</span></label>
                                        </div>
                                    </div>
                                    <!-- * Player 1 -->

                                    <!-- Rating Elo -->
                                    <div class="col-2 p-0 pe-1">
                                        <div class="form-floating">
                                            <input id="rating_h_elo_1" name="rating_h_elo_1" class="form-control fs-15px elo-selected" readonly/>
                                            <label for="rating_h_elo_1" class="d-flex align-items-center fs-13px">H Elo</label>
                                        </div>
                                    </div>
                                    <div class="col-2 p-0 pe-1">
                                        <div class="form-floating">
                                            <input id="rating_c_elo_1" name="rating_c_elo_1" class="form-control fs-15px" readonly/>
                                            <label for="rating_c_elo_1" class="d-flex align-items-center fs-13px">C Elo</label>
                                        </div>
                                    </div>
                                    <div class="col-2 p-0 pe-1">
                                        <div class="form-floating">
                                            <input id="rating_g_elo_1" name="rating_g_elo_1" class="form-control fs-15px" readonly/>
                                            <label for="rating_g_elo_1" class="d-flex align-items-center fs-13px">G Elo</label>
                                        </div>
                                    </div>
                                    <!-- * Rating Elo -->
                                </div>
                                <!-- * Player 1 -->

                                <!-- Player 2 -->
                                <div class="row mt-2">
                                    <div class="col-6">
                                        <div class="form-floating">
                                            <input id="player_2" name="player_name" class="form-control fs-15px"/>
                                            <label for="player_2" class="d-flex align-items-center fs-13px">Player 2<span class="text-danger ms-1">*</span></label>
                                        </div>
                                    </div>
                                    
                                    <!-- Rating Elo -->
                                    <div class="col-2 p-0 pe-1">
                                        <div class="form-floating">
                                            <input id="rating_h_elo_2" name="rating_h_elo_2" class="form-control fs-15px elo-selected" readonly/>
                                            <label for="rating_h_elo_2" class="d-flex align-items-center fs-13px">H Elo</label>
                                        </div>
                                    </div>
                                    <div class="col-2 p-0 pe-1">
                                        <div class="form-floating">
                                            <input id="rating_c_elo_2" name="rating_c_elo_2" class="form-control fs-15px" readonly/>
                                            <label for="rating_c_elo_2" class="d-flex align-items-center fs-13px">C Elo</label>
                                        </div>
                                    </div>
                                    <div class="col-2 p-0 pe-1">
                                        <div class="form-floating">
                                            <input id="rating_g_elo_2" name="rating_g_elo_2" class="form-control fs-15px" readonly/>
                                            <label for="rating_g_elo_2" class="d-flex align-items-center fs-13px">G Elo</label>
                                        </div>
                                    </div>
                                    <!-- * Rating Elo -->
                                </div>
                                <!-- * Player 2 -->

                                <!-- Type -->
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <div class="form-floating">
                                            <select id="type" name="type" class="form-control fs-15px">
                                                <option value="1" data-elo="h">Hard</option>
                                                <option value="2" data-elo="c">Clay</option>
                                                <option value="3" data-elo="g">Grass</option>
                                            </select>
                                            <label for="type" class="d-flex align-items-center fs-13px">Type</label>
                                        </div>
                                    </div>
                                </div>
                                <!-- * Type -->
                            </div>
                        </div>

                        <div class="panel panel-inverse">
                            <div class="panel-heading">
                                <h4 class="panel-title">Result</h4>
                                <div class="panel-heading-btn">
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-success" data-toggle="panel-reload" ><i class="fa fa-redo"></i></a>
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse" ><i class="fa fa-minus"></i></a>
                                </div>
                            </div>
                            <div class="panel-body p-0">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="table-responsive">
                                            <table class="table table-bordered mb-0">
                                                <thead>
                                                    <tr>
                                                        <th>Outcome</th>
                                                        <th>Probability</th>
                                                        <th>Fraction</th>
                                                        <th>Decimal</th>
                                                        <th>American</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr id="result_player_1">
                                                        <td>Player 1 win</td>
                                                        <td class="probability d-none"></td>
                                                        <td class="implied"></td>
                                                        <td class="fraction"></td>
                                                        <td class="decimal"></td>
                                                        <td class="american"></td>
                                                    </tr>
                                                    <tr id="result_player_2">
                                                        <td>Player 2 win</td>
                                                        <td class="probability d-none"></td>
                                                        <td class="implied"></td>
                                                        <td class="fraction"></td>
                                                        <td class="decimal"></td>
                                                        <td class="american"></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                            <table class="table table-bordered mt-2 mb-0">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 50px"></th>
                                                        <th>Content</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td><span class="badge bg-secondary rounded-pill">Stamina</span></td>
                                                        <td class="message-stamina"></td>
                                                    </tr>
                                                    <tr>
                                                        <td><span class="badge bg-secondary rounded-pill">Age</span></td>
                                                        <td class="message-age"></td>
                                                    </tr>
                                                    <tr>
                                                        <td><span class="badge bg-secondary rounded-pill">Probability</span></td>
                                                        <td class="message-probability"></td>
                                                    </tr>
                                                    <tr>
                                                        <td><span class="badge bg-secondary rounded-pill">ELO</span></td>
                                                        <td class="message-elo"></td>
                                                    </tr>
                                                    <tr>
                                                        <td><span class="badge bg-secondary rounded-pill">Form</span></td>
                                                        <td class="message-form"></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-6">
                        <div class="panel panel-inverse">
                            <div class="panel-heading">
                                <h4 class="panel-title">Players</h4>
                                <div class="panel-heading-btn">
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-success" data-toggle="panel-reload" ><i class="fa fa-redo"></i></a>
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse" ><i class="fa fa-minus"></i></a>
                                </div>
                            </div>
                            <div class="panel-body p-0" style="height: 85vh; overflow-y: scroll;">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="table-responsive">
                                            <table class="table table-bordered mb-0 tbl-players">
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Player</th>
                                                        <th>Age</th>
                                                        <th>Elo</th>
                                                        <th>hElo</th>
                                                        <th>cElo</th>
                                                        <th>gElo</th>
                                                        <th>Peak</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td class="text-center" colspan="100%">No data !!!</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <div class="tab-pane fade" id="default-tab-2">
            <main class="m-2">
                <div class="row">
                    <label class="form-label col-form-label col-2">Gender</label>
                    <div class="col-3 pt-2">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" id="gender21" name="gender2" value="man" checked>
                            <label class="form-check-label" for="gender21">Man</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" id="gender22" name="gender2" value="woman">
                            <label class="form-check-label" for="gender22">Woman</label>
                        </div>
                    </div>
                </div>

                <div class="row mt-2">
                    <div class="col-6">
                        <div class="panel panel-inverse">
                            <div class="panel-heading">
                                <h4 class="panel-title">Player information</h4>
                                <div class="panel-heading-btn">
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-success" data-toggle="panel-reload" ><i class="fa fa-redo"></i></a>
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse" ><i class="fa fa-minus"></i></a>
                                </div>
                            </div>
                            <div class="panel-body">
                                <!-- Player 1 -->
                                <div class="row">
                                    <!-- Player 1 -->
                                    <div class="col-5">
                                        <div class="form-floating">
                                            <input id="player_1" name="player_name" class="form-control fs-15px"/>
                                            <label for="player_1" class="d-flex align-items-center fs-13px">Player 1<span class="text-danger ms-1">*</span></label>
                                        </div>
                                    </div>
                                    <!-- * Player 1 -->

                                    <!-- Rating Elo -->
                                    <div class="col-4 p-0 pe-1">
                                        <div class="form-floating">
                                            <input id="rating_serve_1" name="rating_serve_1" class="form-control fs-15px" readonly/>
                                            <label for="rating_serve_1" class="d-flex align-items-center fs-13px">Serve<span class="text-info ms-1">(MW | 1stln | 1st | 2nd)</span></label>
                                        </div>
                                    </div>
                                    <div class="col-3 p-0 pe-1">
                                        <div class="form-floating">
                                            <input id="rating_return_1" name="rating_return_1" class="form-control fs-15px" readonly/>
                                            <label for="rating_return_1" class="d-flex align-items-center fs-13px">Return<span class="text-info ms-1">(RPW | v2nd | Brk)</span></label>
                                        </div>
                                    </div>
                                    <!-- * Rating Elo -->
                                </div>
                                <!-- * Player 1 -->

                                <!-- Player 2 -->
                                <div class="row mt-2">
                                    <div class="col-5">
                                        <div class="form-floating">
                                            <input id="player_2" name="player_name" class="form-control fs-15px"/>
                                            <label for="player_2" class="d-flex align-items-center fs-13px">Player 2<span class="text-danger ms-1">*</span></label>
                                        </div>
                                    </div>
                                    
                                    <!-- Rating Elo -->
                                    <div class="col-4 p-0 pe-1">
                                        <div class="form-floating">
                                            <input id="rating_serve_2" name="rating_serve_2" class="form-control fs-15px" readonly/>
                                            <label for="rating_serve_2" class="d-flex align-items-center fs-13px">Serve<span class="text-info ms-1">(MW | 1stln | 1st | 2nd)</span></label>
                                        </div>
                                    </div>
                                    <div class="col-3 p-0 pe-1">
                                        <div class="form-floating">
                                            <input id="rating_return_2" name="rating_return_2" class="form-control fs-15px" readonly/>
                                            <label for="rating_return_2" class="d-flex align-items-center fs-13px">Return<span class="text-info ms-1">(RPW | v2nd | Brk)</span></label>
                                        </div>
                                    </div>
                                    <!-- * Rating Elo -->
                                </div>
                                <!-- * Player 2 -->

                                <!-- Type -->
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <div class="form-floating">
                                            <select id="type" name="type" class="form-control fs-15px">
                                                <option value="0" data-elo="all">All</option>
                                                <option value="1" data-elo="h">Hard</option>
                                                <option value="2" data-elo="c">Clay</option>
                                                <option value="3" data-elo="g">Grass</option>
                                            </select>
                                            <label for="type" class="d-flex align-items-center fs-13px">Type</label>
                                        </div>
                                    </div>
                                </div>
                                <!-- * Type -->
                            </div>
                        </div>

                        <div class="panel panel-inverse">
                            <div class="panel-heading">
                                <h4 class="panel-title">Result</h4>
                                <div class="panel-heading-btn">
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-success" data-toggle="panel-reload" ><i class="fa fa-redo"></i></a>
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse" ><i class="fa fa-minus"></i></a>
                                </div>
                            </div>
                            <div class="panel-body p-0">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="table-responsive">
                                            <table class="table table-bordered mb-0">
                                                <thead>
                                                    <thead class="text-center">
                                                        <tr>
                                                            <th class="align-middle" rowspan="2">Outcome</th>
                                                            <th class="align-middle" rowspan="2">Age</th>
                                                            <th colspan="4">Serve (%)</th>
                                                            <th colspan="3">Return (%)</th>
                                                        </tr>
                                                        <tr>
                                                            <th>MW</th>
                                                            <th>1stln</th>
                                                            <th>1st</th>
                                                            <th>2nd</th>
                                                            <th>RPW</th>
                                                            <th>v2nd</th>
                                                            <th>Brk</th>
                                                        </tr>
                                                    </thead>
                                                </thead>
                                                <tbody>
                                                    <tr class="result_player_1">
                                                        <td>Player 1</td>
                                                        <td class="age"></td>
                                                        <td class="mw"></td>
                                                        <td class="1stln"></td>
                                                        <td class="1st"></td>
                                                        <td class="2nd"></td>
                                                        <td class="rpw"></td>
                                                        <td class="v2nd"></td>
                                                        <td class="brk"></td>
                                                    </tr>
                                                    <tr class="result_player_2">
                                                        <td>Player 2</td>
                                                        <td class="age"></td>
                                                        <td class="mw"></td>
                                                        <td class="1stln"></td>
                                                        <td class="1st"></td>
                                                        <td class="2nd"></td>
                                                        <td class="rpw"></td>
                                                        <td class="v2nd"></td>
                                                        <td class="brk"></td>
                                                    </tr>
                                                    <tr>
                                                        <td colspan="100%">
                                                            MESSAGE: <strong class="result-message" class="text-danger"></strong>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-6">
                        <div class="panel panel-inverse">
                            <div class="panel-heading">
                                <h4 class="panel-title">Players</h4>
                                <div class="panel-heading-btn">
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-success" data-toggle="panel-reload" ><i class="fa fa-redo"></i></a>
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse" ><i class="fa fa-minus"></i></a>
                                </div>
                            </div>
                            <div class="panel-body p-0" style="height: 85vh; overflow-y: scroll;">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="table-responsive">
                                            <table class="table table-bordered mb-0 tbl-players">
                                                <thead class="text-center">
                                                    <tr>
                                                        <th class="align-middle" rowspan="2">Player</th>
                                                        <th class="align-middle" rowspan="2">Age</th>
                                                        <th colspan="4">Serve (%)</th>
                                                        <th colspan="3">Return (%)</th>
                                                    </tr>
                                                    <tr>
                                                        <th>MW</th>
                                                        <th>1stln</th>
                                                        <th>1st</th>
                                                        <th>2nd</th>
                                                        <th>RPW</th>
                                                        <th>v2nd</th>
                                                        <th>Brk</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td class="text-center" colspan="100%">No data !!!</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
</body>
	<script src="js/view2/menu.min.js"></script>
	<script src="js/view2/main.min.js"></script>
    <script src="js/app.min.js"></script>
    <script src="js/vendor.min.js"></script>
    <script src="js/erf.min.js"></script>
    <script src="js/utils.min.js"></script>
	<script>

	function sortable(d){
		return Object.entries(d)
		    .sort(([,a],[,b]) => a-b)
		    .reduce((r, [k, v]) => ({ ...r, [k]: v }), {});
	}
		
    function loadPlayers2(){
        // Tab2
        const gender = $(`#default-tab-2 input[name=gender2]:checked`).val()
    	matchmx = dataset.tab2.matchmx[gender]
    	makeMatch()
        const data = sortable(dataset.tab2.crank[gender])
        const players = dataset.tab2.matches

        if(Object.keys(data).length > 0){
        	$("#default-tab-2 .tbl-players tbody").html("")
	        for(var key in data){
	        	const item = players[`${key}`]
	        	if(item == null) continue;
	            $("#default-tab-2 .tbl-players tbody").append(`
	                <tr>
	                    <td><label class="mw-180px text-truncate" title="${key}">[${data[key]}]${key}</label></td>
	                    <td>${item[0]}</td>
	                    <td>${item[1]}</td>
	                    <td>${item[2]}</td>
	                    <td>${item[3]}</td>
	                    <td>${item[4]}</td>
	                    <td>${item[5]}</td>
	                    <td>${item[6]}</td>
	                    <td>${item[7]}</td>
	                </tr>
	            `)
	        }
	        $("#default-tab-2 input[name=player_name]").autocomplete({source: Object.keys(data)})
        }else{
        	$("#default-tab-2 .tbl-players tbody").html(`<tr><td class="text-center" colspan="100%">No data !!!</td></tr>`)
        }

    }

    function loadPlayers1(){
        // Tab1
        const gender1 = $(`#default-tab-1 input[name=gender1]:checked`).val()
        const data = dataset.tab1.tennis[gender1]
        if(data.length > 0){
            $("#default-tab-1 .tbl-players tbody").html("")
            for(var i = 0; i < data.length; i++){
                $("#default-tab-1 .tbl-players tbody").append(`
                    <tr>
                        <td>${i+1}</td>
                        <td><label class="mw-80px text-truncate" title="${data[i].name}">${data[i].name}</label></td>
                        <td>${data[i].age}</td>
                        <td>${data[i].elo}</td>
                        <td>${data[i].hElo}</td>
                        <td>${data[i].cElo}</td>
                        <td>${data[i].gElo}</td>
                        <td>${data[i].peakElo}</td>
                    </tr>
                `)
            }
            $("#default-tab-1 input[name=player_name]").autocomplete({source: dataset.tab1.tennisM[gender1]})
        }else{
            $("#default-tab-1 .tbl-players tbody").html(`<tr><td class="text-center" colspan="100%">No data !!!</td></tr>`)
        }
    }

    $(document).ready(function(){
    	init()
    })

    async function init(){
        await dataOdds()
        await dataPlayer()
    	actionView()
        loadPlayers1()
        loadPlayers2()
    }

    async function dataOdds(){
        const data = await rest.get("http://127.0.0.1:81/odds", "")
        dataset.tab1.odds = data
    }

    async function dataPlayer(){
        const dataMan = await rest.get("http://127.0.0.1:81/tennis/1", "")
        const dataWoman = await rest.get("http://127.0.0.1:81/tennis/0", "")
        dataset.tab1.tennis.man = dataMan
        dataset.tab1.tennis.woman = dataWoman
        dataset.tab1.tennisM.man = dataset.tab1.tennis.man.map(function(item) {
            return item.name;
        });
        dataset.tab1.tennisM.woman = dataset.tab1.tennis.woman.map(function(item) {
            return item.name;
        });
    }

    async function getPlayerRate(name){
        name = name.replace(/\s/g, '');
        console.log(name)
        const data = await rest.get(`http://127.0.0.1:81/tennis/recent/${name}`)
        return data
    }

    function actionView(){
    	$("#default-tab-2 input[name=gender2]").change(function(){
    		loadPlayers2()
			$(`#default-tab-2 input[name=player_name]`).val("")
			$(`#default-tab-2 input[name=player_name]`).removeClass("is-valid")
			$(`#default-tab-2 input[name=player_name]`).removeClass("is-invalid")
			$(`#default-tab-2 input[name=rating_serve_1]`).val("")
			$(`#default-tab-2 input[name=rating_return_1]`).val("")
			$(`#default-tab-2 input[name=rating_serve_2]`).val("")
			$(`#default-tab-2 input[name=rating_return_2]`).val("")
            $(`#default-tab-2 .result_player_1 span`).remove()
            $(`#default-tab-2 .result_player_2 span`).remove()
            $(`#default-tab-2 .result-message`).html("")
            dataset.tab2.player[`p_1`] = null
            dataset.tab2.player[`p_2`] = null
    	})

    	$(`#default-tab-2 input[name=player_name]`).keyup(function(){
    		var id = $(this).attr('id')
    		id = id.replace("player_", "")
			$(`#default-tab-2 input[name=rating_serve_${id}]`).val("")
			$(`#default-tab-2 input[name=rating_return_${id}]`).val("")
			$(this).removeClass("is-valid")
			$(this).removeClass("is-invalid")
    	})
    	$(`#default-tab-2 input[name=player_name]`).change(function(){
    		var id = $(this).attr('id')
    		id = id.replace("player_", "")
    		const name = $(this).val()
    		const gender = $("#default-tab-2 input[name=gender2]:checked").val()

    		const index = Object.keys(dataset.tab2.crank[gender]).indexOf(name)
    		if(index != -1){
    			const playerInfo = dataset.tab2.matches[name]
    			dataset.tab2.player[`p_${id}`] = playerInfo
    			$(`#default-tab-2 input[name=rating_serve_${id}]`).val(`${playerInfo[1]} | ${playerInfo[2]} | ${playerInfo[3]} | ${playerInfo[4]}`)
				$(`#default-tab-2 input[name=rating_return_${id}]`).val(`${playerInfo[5]} | ${playerInfo[6]} | ${playerInfo[7]}`)
    			$(this).addClass("is-valid")
                applyParams2()
    		}else{
                dataset.tab2.player[`p_${id}`] = null
    			$(this).addClass("is-invalid")
    		}
    	})
    	$("#default-tab-2 select[name=type]").change(function(){
            var val = $(this).find(":selected").val()*1
            $(`.surfacechoice`).removeClass("selected")
            $(`.surfacechoice`).removeClass("surfaceselected")
            if(val!=0){
                $(`#surface${val-1}`).addClass("selected")
                $(`#surface${val-1}`).addClass("surfaceselected")
            }else{
                $(`#surfacedef`).addClass("selected")
                $(`#surfacedef`).addClass("surfaceselected")
            }
            loadPlayers2()
            $(`#default-tab-2 input[name=player_name]`).change()
    	})

        $("#default-tab-1 input[name=gender1]").change(function(){
            const gender = $(this).val()
            loadPlayers1()

            $(`#default-tab-1 input[name=player_name]`).val("")
            $(`#default-tab-1 input[name=player_name]`).removeClass("is-valid")
            $(`#default-tab-1 input[name=player_name]`).removeClass("is-invalid")
            $(`#default-tab-1 input[name=rating_h_elo_1]`).val("")
            $(`#default-tab-1 input[name=rating_c_elo_1]`).val("")
            $(`#default-tab-1 input[name=rating_g_elo_1]`).val("")

            $(`#default-tab-1 input[name=rating_h_elo_2]`).val("")
            $(`#default-tab-1 input[name=rating_c_elo_2]`).val("")
            $(`#default-tab-1 input[name=rating_g_elo_2]`).val("")

            $("#default-tab-1 .probability").html("")
            $("#default-tab-1 .implied").html("")
            $("#default-tab-1 .fraction").html("")
            $("#default-tab-1 .decimal").html("")
            $("#default-tab-1 .american").html("")
            //$("#default-tab-1 .result-message").html("")

            dataset.tab1.player[`p_1`] = null
            dataset.tab1.player[`p_2`] = null
        })

        $(`#default-tab-1 input[name=player_name]`).keyup(function(){
            var id = $(this).attr('id')
            id = id.replace("player_", "")
            $(`#default-tab-1 input[name=rating_h_elo_${id}]`).val("")
            $(`#default-tab-1 input[name=rating_c_elo_${id}]`).val("")
            $(`#default-tab-1 input[name=rating_g_elo_${id}]`).val("")
            $(this).removeClass("is-valid")
            $(this).removeClass("is-invalid")
        })
        $(`#default-tab-1 input[name=player_name]`).change(function(){
            var id = $(this).attr('id')
            id = id.replace("player_", "")
            const name = $(this).val()
            const gender = $("#default-tab-1 input[name=gender1]:checked").val()

            const index = dataset.tab1.tennisM[gender].indexOf(name)
            if(index != -1){
                dataset.tab1.player[`p_${id}`] = dataset.tab1.tennis[gender][index]
                $(`#default-tab-1 input[name=rating_h_elo_${id}]`).val(dataset.tab1.tennis[gender][index].hElo)
                $(`#default-tab-1 input[name=rating_c_elo_${id}]`).val(dataset.tab1.tennis[gender][index].cElo)
                $(`#default-tab-1 input[name=rating_g_elo_${id}]`).val(dataset.tab1.tennis[gender][index].gElo)
                $(this).addClass("is-valid")
                applyParams1()
            }else{
                dataset.tab1.player[`p_${id}`] = null
                $(this).addClass("is-invalid")
            }
        })
        $("#default-tab-1 select[name=type]").change(function(){
            const elo = $(this).find(":selected").data("elo")
            $(`#default-tab-1 input[name=rating_h_elo_1]`).removeClass("elo-selected")
            $(`#default-tab-1 input[name=rating_c_elo_1]`).removeClass("elo-selected")
            $(`#default-tab-1 input[name=rating_g_elo_1]`).removeClass("elo-selected")
            $(`#default-tab-1 input[name=rating_h_elo_2]`).removeClass("elo-selected")
            $(`#default-tab-1 input[name=rating_c_elo_2]`).removeClass("elo-selected")
            $(`#default-tab-1 input[name=rating_g_elo_2]`).removeClass("elo-selected")

            $(`#default-tab-1 input[name=rating_${elo}_elo_1]`).addClass("elo-selected")
            $(`#default-tab-1 input[name=rating_${elo}_elo_2]`).addClass("elo-selected")
            applyParams1()
        })
    }


	function applyParams2() {
	    if(dataset.tab2.player.p_1.length > 0 && dataset.tab2.player.p_2.length > 0){
	 		const p1 = dataset.tab2.player.p_1;
	 		const p2 = dataset.tab2.player.p_2;
	 		var chs = []
	        for(var i = 0; i < p1.length; i++){
	        	/**
	        	* if(p1 > p2) => value 1
	        	* else => value 0
	        	*/
	        	const val = p1[i]*1 > p2[i]*1 ? 1 : 0
	        	if(i > 0){
		        	$("#default-tab-2 .result_player_1").find(`td:eq(${i+1})`).html(`<span class="${val ? "text-success" : "text-danger"}">${p1[i]}</span>`)
		        	$("#default-tab-2 .result_player_2").find(`td:eq(${i+1})`).html(`<span class="${!val ? "text-success" : "text-danger"}">${p2[i]}</span>`)
	        		chs.push(val)
	        	}else{
	        		$("#default-tab-2 .result_player_1").find(`td:eq(${i+1})`).html(`<span>${p1[i]}</span>`)
		        	$("#default-tab-2 .result_player_2").find(`td:eq(${i+1})`).html(`<span>${p2[i]}</span>`)
	        	}
	        }
            const elo = $("#default-tab-2 select[name=type]").find(":selected").data("elo")
            const eloText = $("#default-tab-2 select[name=type]").find(":selected").text()
	        const cnt1 = chs.filter(x => x==1).length
	        const cnt2 = chs.length - cnt1

	        var message = ""
	        switch(elo){
	        	case "g": 
	        		message = `${chs[0] + chs[2] + chs[4] >= 2 ? "Player 1" : "Player 2"} is more reliable on ${eloText} court than ${chs[0] + chs[2] + chs[4] >= 2 ? "Player 2" : "Player 1"}`
	        		break;
                case "h": 
                case "c":
                default:  
                    message = `${cnt1 > cnt2 ? "Player 1" : "Player 2"} is more reliable on ${eloText} court than ${cnt1 > cnt2 ? "Player 2" : "Player 1"}`
                    break;
	        }
	        $("#default-tab-2 .result-message").html(message)

	    }
	}
	</script>

<script>
function getRating(player){
    const type = $("#default-tab-1 select[name=type]").find(":selected").data("elo")
    var rate = 0
    switch(type){
        case "h":
            rate = player.hElo
            break;
        case "c":
            rate = player.cElo
            break;
        case "g":
            rate = player.gElo
            break;
        default:
            rate = player.hElo
            break;
    }
    return rate
}

function findOdds(prob){
    const tmpProb = prob * 100
    if(tmpProb < 99){
        for(var i = 0; i < dataset.tab1.odds.length - 1; i++){
            var o1 = dataset.tab1.odds[i]
            var implied1 = parseFloat(o1.implied.replace("%", ""))
            var o2 = dataset.tab1.odds[i+1]
            var implied2 = parseFloat(o2.implied.replace("%", ""))
            
            // console.log(`${tmpProb} - ${implied1} - ${implied2}: ${(tmpProb >= implied1 && tmpProb < implied2)}`)
            if(tmpProb >= implied2 && tmpProb < implied1){
                return [o1, `${implied2}% - ${implied1}%`]
            }
        }
    }else{
        return [dataset.tab1.odds[0], `99% - 100%`]
    }
}

async function applyParams1() {
    $("#default-tab-1 .message-age").html("")
    $("#default-tab-1 .message-probability").html("")
    $("#default-tab-1 .message-elo").html("")
    $("#default-tab-1 .message-stamina").html("")
    $("#default-tab-1 .message-form").html("")
    
    if(dataset.tab1.player.p_1.name != undefined && dataset.tab1.player.p_2.name != undefined){
        //$("#default-tab-1 .result-message").html("")
        var rating1 = getRating(dataset.tab1.player.p_1);
        var rating2 = getRating(dataset.tab1.player.p_2);

        var eloDiffH = fnEloDiff(parseFloat(rating1), parseFloat(rating2), "random")
        var eloDiff = eloDiffH.toFixed(0)
        var eScoreH = eloFn(eloDiffH)
        var eScore = eScoreH.toFixed(9);
        updateProbabilities(eScoreH, 0);

        // Check age
        if(dataset.tab1.player.p_1.age > dataset.tab1.player.p_2.age){
            $("#default-tab-1 .message-age").append(`Tennis player [${dataset.tab1.player.p_1.name}] is older than tennis player [${dataset.tab1.player.p_2.name}].<br>`)
        }else{
            $("#default-tab-1 .message-age").append(`Tennis player [${dataset.tab1.player.p_2.name}] is older than tennis player [${dataset.tab1.player.p_1.name}].<br>`)
        }
        if(dataset.tab1.player.p_1.age > 30) $("#default-tab-1 .message-age").append(`Player [${dataset.tab1.player.p_1.name}] over 30 years old<br>`)
        if(dataset.tab1.player.p_2.age > 30) $("#default-tab-1 .message-age").append(`Player [${dataset.tab1.player.p_2.name}] over 30 years old<br>`)

        // Check Elo
        let p1Elo = dataset.tab1.player.p_1.peakElo - dataset.tab1.player.p_1.elo
        let p2Elo = dataset.tab1.player.p_2.peakElo - dataset.tab1.player.p_2.elo
        $("#default-tab-1 .message-elo").append(`[${dataset.tab1.player.p_1.name}]: Peak elo (${dataset.tab1.player.p_1.peakElo}) - Current elo (${dataset.tab1.player.p_1.elo}) = ${p1Elo.toFixed(0)} points from peak<br>`)
        $("#default-tab-1 .message-elo").append(`[${dataset.tab1.player.p_2.name}]: Peak elo (${dataset.tab1.player.p_2.peakElo}) - Current elo (${dataset.tab1.player.p_2.elo}) = ${p2Elo.toFixed(0)} points from peak<br>`)
        if(p1Elo > p2Elo){
            $("#default-tab-1 .message-elo").append(`=> [${dataset.tab1.player.p_1.name}] is currently further.`)
        }else{
            $("#default-tab-1 .message-elo").append(`=> [${dataset.tab1.player.p_2.name}] is currently further.`)
        }

        // Stamina
        let rateP1 = await getPlayerRate(dataset.tab1.player.p_1.name);
        let rateP2 = await getPlayerRate(dataset.tab1.player.p_2.name);

        let recentsP1 = rateP1.recents;
        let recentsP2 = rateP2.recents;

        let totalSourceP1 = 0, totalSourceP2 = 0;
        let totalTimeP1 = 0, totalTimeP2 = 0
        for(let i = 0; i < recentsP1.length; i++){
            totalSourceP1 += recentsP1[i].totalSource
            totalTimeP1 += recentsP1[i].time
        }

        $("#default-tab-1 .message-stamina").append(`[${dataset.tab1.player.p_1.name}]: ${totalSourceP1} games and ${recentsP1.length} this week, last match lasts ${totalTimeP1.toFixed(2)} hours.<br>`)

        for(let i = 0; i < recentsP2.length; i++){
            totalSourceP2 += recentsP2[i].totalSource
            totalTimeP2 += recentsP2[i].time
        }
        $("#default-tab-1 .message-stamina").append(`[${dataset.tab1.player.p_2.name}]: ${totalSourceP2} games and ${recentsP2.length} this week, last match lasts ${totalTimeP2.toFixed(2)} hours.<br>`)
        if(totalSourceP1 > totalSourceP2 && totalTimeP1 > totalTimeP2) $("#default-tab-1 .message-stamina").append(`=> ${dataset.tab1.player.p_2.name} has less stamina than ${dataset.tab1.player.p_1.name} before this match`)
        else if (totalSourceP1 < totalSourceP2 && totalTimeP1 < totalTimeP2) $("#default-tab-1 .message-stamina").append(`=> ${dataset.tab1.player.p_1.name} has less stamina than ${dataset.tab1.player.p_2.name} before this match`)


        let typeIndex = $("#default-tab-1 select[name=type]").prop('selectedIndex')
        let tourLevelP1 = rateP1.tourLevels[typeIndex]
        let tourLevelP2 = rateP2.tourLevels[typeIndex]
        let typeText = $("#default-tab-1 select[name=type] option:selected").text()

        if(
            tourLevelP1.win > tourLevelP2.win 
            && tourLevelP1.m > tourLevelP2.m
        ) $("#default-tab-1 .message-form").html(`Player [${dataset.tab1.player.p_1.name}] has better ${typeText} court form than player [${dataset.tab1.player.p_2.name}].`)
        else $("#default-tab-1 .message-form").html(`Player [${dataset.tab1.player.p_2.name}] has better ${typeText} court form than player [${dataset.tab1.player.p_1.name}].`)
    }
}

// Use high-precision eScore and drawProb to avoid rounding issues.
/**
* NaN, 0
*/
function updateProbabilities(eScore, drawProb) {
    var scoreStr = "0-0"
    var parts = scoreStr.split("-");
    var s1 = 0;
    var s2 = 0;
    if (parts.length == 2) {
        s1 = parseFloat(parts[0]);
        s2 = parseFloat(parts[1]);
    }

    // var tournament = $("input[name=tournament]:checked").val();
    var tournament = "best-of"
    var probs;

    if (parts.length != 2)
        probs = ["(current score has wrong format)", "", ""];
    else if (tournament == "best-of") {
        // var n = parseInt($("input[name=best-of]").val());
        var n = 3
        var winProb = eScore - drawProb/2;
        probs = computeProbBestOf(n, winProb, drawProb, s1, s2);
    }
    else if (tournament == "margin") {
        if (drawProb == 0) {
            var n = parseInt($("input[name=margin]").val());
            probs = computeProbMargin(n, eScore, s1, s2);
        }
        else {
            probs = ["(margin-of-two with non-zero draw probability is not implemented)", "", ""];
        }
    
    }
    else
        probs = ["?", "?", "?"];

    const odds1 = findOdds(probs[0])
    const odds2 = findOdds(probs[1])

    $("#result_player_1 .probability").html(`<label class="mw-50px text-truncate" title="${probs[0]}">${probs[0]}</label>`);
    $("#result_player_1 .implied").html(`<span class="badge bg-secondary">${odds1[1]}</span>`);
    $("#result_player_1 .fraction").text(odds1[0].fraction);
    $("#result_player_1 .decimal").text(odds1[0].decimal);
    $("#result_player_1 .american").text(odds1[0].american);

    $("#result_player_2 .probability").html(`<label class="mw-50px text-truncate" title="${probs[1]}">${probs[1]}</label>`);
    $("#result_player_2 .implied").html(`<span class="badge bg-secondary">${odds2[1]}</span>`);
    $("#result_player_2 .fraction").text(odds2[0].fraction);
    $("#result_player_2 .decimal").text(odds2[0].decimal);
    $("#result_player_2 .american").text(odds2[0].american);

    if(odds1[1] > odds2[1]){
        $("#default-tab-1 .message-probability").append(`Player [${dataset.tab1.player.p_1.name}] has better on-court skills than player [${dataset.tab1.player.p_2.name}].`)
    }else{
        $("#default-tab-1 .message-probability").append(`Player [${dataset.tab1.player.p_2.name}] has better on-court skills than player [${dataset.tab1.player.p_1.name}].`)
    }
    // $("span#draw").text(probs[2]);
}

function computeProbBestOf(n, winProb, drawProb, s1, s2) {
    if (s1 * 2 != Math.floor(s1 * 2) || s2 * 2 != Math.floor(s2 * 2))
        return ["(current score is not composed of half-integers)", "", ""];
    if (s1 + s2 != Math.floor(s1 + s2))
        return ["(current score doesn't sum to an integer)", "", ""];
    if (isNaN(n) || isNaN(winProb) || isNaN(drawProb))
        return ["?", "?", "?"];
    if (s1 < 0 || s2 < 0)
        return ["(current score contains a negative number)", "", ""];
    if (s1 + s2 > n)
        return ["(current score sum exceeds match length)", "", ""];

    // Allocate. Tables are indexed by units of half-points.
    var winTable = [];
    var drawTable = [];
    for (var i = 0; i <= 2*n; i++) {
        winTable[i] = [];
        drawTable[i] = [];
    }

    // Boundary conditions.
    for (var i = 0; i <= 2*n; i++) {
        var j = 2*n - i;
        winTable[i][j] = (i > j ? 1 : 0);
        drawTable[i][j] = (i == j ? 1 : 0);
    }

    // Fill rest using recurrence.
    var loseProb = 1 - winProb - drawProb;
    for (var sum = n - 1; sum >= s1 + s2; sum--) {
        for (var i = 0; i <= 2*sum; i++) {
            var j = 2*sum - i;
            winTable[i][j] = winProb * winTable[i+2][j] +
                             drawProb * winTable[i+1][j+1] +
                             loseProb * winTable[i][j+2];
            drawTable[i][j] = winProb * drawTable[i+2][j] +
                              drawProb * drawTable[i+1][j+1] +
                              loseProb * drawTable[i][j+2];
        }
    }
    var win = winTable[s1*2][s2*2];
    var draw = drawTable[s1*2][s2*2];
    var lose = 1 - win - draw;

    // Prevent "-0.000000000" from being displayed.
    if (Math.abs(win) < 1e-10) win = 0;
    if (Math.abs(lose) < 1e-10) lose = 0;
    if (Math.abs(draw) < 1e-10) draw = 0;

    return [win.toFixed(9), lose.toFixed(9), draw.toFixed(9)];
}

function computeProbMargin(n, p, s1, s2) {
    if (s1 != Math.floor(s1) || s2 != Math.floor(s2))
        return ["(current score is not composed of integers)", "", ""];
    if (isNaN(n) || isNaN(p))
        return ["?", "?", "?"];
    if (s1 < 0 || s2 < 0)
        return ["(current score contains a negative number)", "", ""];

    var E = p*p / (1 - 2*(1-p)*p);  // Prob if equal.
    var A = (1 - (1-p)*p)/p * E;    // Prob if player1 advantage.
    var D = p * E;                  // Prob if player1 disadvantage.

    var win;
    if (s1 > n || s2 > n) {
        var diff = s1 - s2;
        if (diff == 2)
            win = 1;
        else if (diff == 1)
            win = A;
        else if (diff == 0)
            win = E;
        else if (diff == -1)
            win = D;
        else if (diff == -2)
            win = 0;
        else
            return ["?", "?", "?"];
    }
    else {
        // Allocate.
        var winTable = [];
        for (var i = 0; i <= n; i++)
            winTable[i] = [];

        // Boundary conditions.
        for (var i = 0; i <= n-2; i++) {
            winTable[i][n] = 0;
            winTable[n][i] = 1;
        }
        winTable[n][n] = E;
        winTable[n][n-1] = A;
        winTable[n-1][n] = D;

        // Fill rest using recurrence.
        for (var i = n - 1; i >= s1; i--) {
            for (var j = n - 1; j >= s2; j--) {
                winTable[i][j] = p * winTable[i+1][j] +
                                 (1 - p) * winTable[i][j+1];
            }
        }
        win = winTable[s1][s2];
    }

    var lose = 1 - win;
    var draw = 0;
    return [win.toFixed(9), lose.toFixed(9), draw.toFixed(9)];
}

function eloFn(eloDiff) {
    // var formula = $("input[name=formula]:checked").val();
    var formula = "logistic"
    return (formula == "normal") ?
           eloNormal(eloDiff) : eloLogistic(eloDiff);
}
</script>

</html>