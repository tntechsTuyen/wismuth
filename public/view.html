<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Hello World!</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
	<link rel="stylesheet" type="text/css" href="css/app.min.css">
	<link rel="stylesheet" type="text/css" href="css/vendor.min.css">
	<link rel="stylesheet" type="text/css" href="css/style.min.css">
	<link rel="stylesheet" type="text/css" href="plugins/jquery-ui/css/jquery-ui.css">
	<script src="plugins/jquery/jquery.min.js"></script>
	<script src="plugins/jquery-ui/js/jquery-ui.js"></script>
</head>
<body>
    <main class="m-2">
        <div class="row">
            <label class="form-label col-form-label col-2">Gender</label>
            <div class="col-3 pt-2">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" id="gender1" name="gender" value="man" checked>
                    <label class="form-check-label" for="gender1">Man</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" id="gender2" name="gender" value="woman">
                    <label class="form-check-label" for="gender2">Woman</label>
                </div>
            </div>
        </div>

        <div class="row mt-2">
            <div class="col-6">
                <div class="panel panel-inverse">
                    <div class="panel-heading">
                        <h4 class="panel-title">Player information</h4>
                        <div class="panel-heading-btn">
                            <a href="javascript:;" class="btn btn-xs btn-icon btn-success" data-toggle="panel-reload" ><i class="fa fa-redo"></i></a>
                            <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse" ><i class="fa fa-minus"></i></a>
                        </div>
                    </div>
                    <div class="panel-body">
                        <!-- Player 1 -->
                        <div class="row">
                            <!-- Player 1 -->
                            <div class="col-6">
                                <div class="form-floating">
                                    <input id="player_1" name="player_name" class="form-control fs-15px"/>
                                    <label for="player_1" class="d-flex align-items-center fs-13px">Player 1<span class="text-danger ms-1">*</span></label>
                                </div>
                            </div>
                            <!-- * Player 1 -->

                            <!-- Rating Elo -->
                            <div class="col-2 p-0 pe-1">
                                <div class="form-floating">
                                    <input id="rating_h_elo_1" name="rating_h_elo_1" class="form-control fs-15px elo-selected" readonly/>
                                    <label for="rating_h_elo_1" class="d-flex align-items-center fs-13px">H Elo</label>
                                </div>
                            </div>
                            <div class="col-2 p-0 pe-1">
                                <div class="form-floating">
                                    <input id="rating_c_elo_1" name="rating_c_elo_1" class="form-control fs-15px" readonly/>
                                    <label for="rating_c_elo_1" class="d-flex align-items-center fs-13px">C Elo</label>
                                </div>
                            </div>
                            <div class="col-2 p-0 pe-1">
                                <div class="form-floating">
                                    <input id="rating_g_elo_1" name="rating_g_elo_1" class="form-control fs-15px" readonly/>
                                    <label for="rating_g_elo_1" class="d-flex align-items-center fs-13px">G Elo</label>
                                </div>
                            </div>
                            <!-- * Rating Elo -->
                        </div>
                        <!-- * Player 1 -->

                        <!-- Player 2 -->
                        <div class="row mt-2">
                            <div class="col-6">
                                <div class="form-floating">
                                    <input id="player_2" name="player_name" class="form-control fs-15px"/>
                                    <label for="player_2" class="d-flex align-items-center fs-13px">Player 2<span class="text-danger ms-1">*</span></label>
                                </div>
                            </div>
                            
                            <!-- Rating Elo -->
                            <div class="col-2 p-0 pe-1">
                                <div class="form-floating">
                                    <input id="rating_h_elo_2" name="rating_h_elo_2" class="form-control fs-15px elo-selected" readonly/>
                                    <label for="rating_h_elo_2" class="d-flex align-items-center fs-13px">H Elo</label>
                                </div>
                            </div>
                            <div class="col-2 p-0 pe-1">
                                <div class="form-floating">
                                    <input id="rating_c_elo_2" name="rating_c_elo_2" class="form-control fs-15px" readonly/>
                                    <label for="rating_c_elo_2" class="d-flex align-items-center fs-13px">C Elo</label>
                                </div>
                            </div>
                            <div class="col-2 p-0 pe-1">
                                <div class="form-floating">
                                    <input id="rating_g_elo_2" name="rating_g_elo_2" class="form-control fs-15px" readonly/>
                                    <label for="rating_g_elo_2" class="d-flex align-items-center fs-13px">G Elo</label>
                                </div>
                            </div>
                            <!-- * Rating Elo -->
                        </div>
                        <!-- * Player 2 -->

                        <!-- Type -->
                        <div class="row mt-2">
                            <div class="col-12">
                                <div class="form-floating">
                                    <select id="type" name="type" class="form-control fs-15px">
                                        <option value="1" data-elo="h">Hard</option>
                                        <option value="2" data-elo="c">Clay</option>
                                        <option value="3" data-elo="g">Grass</option>
                                    </select>
                                    <label for="type" class="d-flex align-items-center fs-13px">Type</label>
                                </div>
                            </div>
                        </div>
                        <!-- * Type -->
                    </div>
                </div>

                <div class="panel panel-inverse">
                    <div class="panel-heading">
                        <h4 class="panel-title">Result</h4>
                        <div class="panel-heading-btn">
                            <a href="javascript:;" class="btn btn-xs btn-icon btn-success" data-toggle="panel-reload" ><i class="fa fa-redo"></i></a>
                            <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse" ><i class="fa fa-minus"></i></a>
                        </div>
                    </div>
                    <div class="panel-body p-0">
                        <div class="row">
                            <div class="col-12">
                                <div class="table-responsive">
                                    <table class="table table-bordered mb-0">
                                        <thead>
                                            <tr>
                                                <th>Outcome</th>
                                                <th colspan="2">Probability</th>
                                                <th>Fraction</th>
                                                <th>Decimal</th>
                                                <th>American</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr id="result_player_1">
                                                <td>Player 1 win</td>
                                                <td class="probability"></td>
                                                <td class="implied"></td>
                                                <td class="fraction"></td>
                                                <td class="decimal"></td>
                                                <td class="american"></td>
                                            </tr>
                                            <tr id="result_player_2">
                                                <td>Player 2 win</td>
                                                <td class="probability"></td>
                                                <td class="implied"></td>
                                                <td class="fraction"></td>
                                                <td class="decimal"></td>
                                                <td class="american"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-6">
                <div class="panel panel-inverse">
                    <div class="panel-heading">
                        <h4 class="panel-title">Players</h4>
                        <div class="panel-heading-btn">
                            <a href="javascript:;" class="btn btn-xs btn-icon btn-success" data-toggle="panel-reload" ><i class="fa fa-redo"></i></a>
                            <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse" ><i class="fa fa-minus"></i></a>
                        </div>
                    </div>
                    <div class="panel-body p-0" style="height: 85vh; overflow-y: scroll;">
                        <div class="row">
                            <div class="col-12">
                                <div class="table-responsive">
                                    <table id="tbl-players" class="table table-bordered mb-0">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Player</th>
                                                <th>Age</th>
                                                <th>Elo</th>
                                                <th>hElo</th>
                                                <th>cElo</th>
                                                <th>gElo</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="text-center" colspan="100%">No data !!!</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    

</body>
<script src="js/erf.min.js"></script>
<script src="js/utils.min.js"></script>
<script>
	var dataset = {}	

    window.bridge.sendSettings((event, settings) => {
    	dataset = settings
    	dataset.tennis = settings.tennis
        dataset.odds = settings.odds
    	dataset.tennisM = {}
    	dataset.player = {"p_1": {},"p_2": {}}
    	dataset.tennisM.man = dataset.tennis.man.map(function(item) {
			return item.name;
		});
		dataset.tennisM.woman = dataset.tennis.woman.map(function(item) {
			return item.name;
		});
        loadPlayers()
    });

    function loadPlayers(){
        const gender = $(`input[name=gender]:checked`).val()
        const data = dataset.tennis[gender]
        
        if(data.length > 0){
        	$("#tbl-players tbody").html("")
	        for(var i = 0; i < data.length; i++){
	            $("#tbl-players tbody").append(`
	                <tr>
	                    <td>${i+1}</td>
	                    <td><label class="mw-80px text-truncate" title="${data[i].name}">${data[i].name}</label></td>
	                    <td>${data[i].age}</td>
	                    <td>${data[i].elo}</td>
	                    <td>${data[i].hElo}</td>
	                    <td>${data[i].cElo}</td>
	                    <td>${data[i].gElo}</td>
	                </tr>
	            `)
	        }
	        $("input[name=player_name]").autocomplete({source: dataset.tennisM[gender]})
        }else{
        	$("#tbl-players tbody").html(`<tr><td class="text-center" colspan="100%">No data !!!</td></tr>`)
        }
    }

    $(document).ready(function(){
    	init()
    })

    function init(){
    	actionView()
    }

    function actionView(){
    	$("input[name=gender]").change(function(){
    		const gender = $(this).val()
    		loadPlayers()

			$(`input[name=player_name]`).val("")
			$(`input[name=player_name]`).removeClass("is-valid")
			$(`input[name=player_name]`).removeClass("is-invalid")
			$(`input[name=rating_h_elo_1]`).val("")
			$(`input[name=rating_c_elo_1]`).val("")
			$(`input[name=rating_g_elo_1]`).val("")

			$(`input[name=rating_h_elo_2]`).val("")
			$(`input[name=rating_c_elo_2]`).val("")
			$(`input[name=rating_g_elo_2]`).val("")

            $(".probability").html("")
            $(".implied").html("")
            $(".fraction").html("")
            $(".decimal").html("")
            $(".american").html("")

            dataset.player[`p_1`] = null
            dataset.player[`p_2`] = null
    	})

    	$(`input[name=player_name]`).keyup(function(){
    		var id = $(this).attr('id')
    		id = id.replace("player_", "")
			$(`input[name=rating_h_elo_${id}]`).val("")
			$(`input[name=rating_c_elo_${id}]`).val("")
			$(`input[name=rating_g_elo_${id}]`).val("")
			$(this).removeClass("is-valid")
			$(this).removeClass("is-invalid")
    	})
    	$(`input[name=player_name]`).change(function(){
    		var id = $(this).attr('id')
    		id = id.replace("player_", "")
    		const name = $(this).val()
    		const gender = $("input[name=gender]:checked").val()

    		const index = dataset.tennisM[gender].indexOf(name)
    		if(index != -1){
    			dataset.player[`p_${id}`] = dataset.tennis[gender][index]
    			$(`input[name=rating_h_elo_${id}]`).val(dataset.tennis[gender][index].hElo)
				$(`input[name=rating_c_elo_${id}]`).val(dataset.tennis[gender][index].cElo)
				$(`input[name=rating_g_elo_${id}]`).val(dataset.tennis[gender][index].gElo)
    			$(this).addClass("is-valid")
                applyParams()
    		}else{
                dataset.player[`p_${id}`] = null
    			$(this).addClass("is-invalid")
    		}
    	})
    	$("select[name=type]").change(function(){
    		const elo = $(this).find(":selected").data("elo")
    		$(`input[name=rating_h_elo_1]`).removeClass("elo-selected")
			$(`input[name=rating_c_elo_1]`).removeClass("elo-selected")
			$(`input[name=rating_g_elo_1]`).removeClass("elo-selected")
    		$(`input[name=rating_h_elo_2]`).removeClass("elo-selected")
			$(`input[name=rating_c_elo_2]`).removeClass("elo-selected")
			$(`input[name=rating_g_elo_2]`).removeClass("elo-selected")

    		$(`input[name=rating_${elo}_elo_1]`).addClass("elo-selected")
    		$(`input[name=rating_${elo}_elo_2]`).addClass("elo-selected")
            applyParams()
    	})
    }
</script>

<script>
function getRating(player){
	const type = $("select[name=type]").find(":selected").data("elo")
	var rate = 0
	switch(type){
		case "h":
			rate = player.hElo
			break;
		case "c":
			rate = player.cElo
			break;
		case "g":
			rate = player.gElo
			break;
		default:
			rate = player.hElo
			break;
	}
	return rate
}

function findOdds(prob){
    const tmpProb = prob * 100
    if(tmpProb < 99){
        for(var i = 0; i < dataset.odds.length - 1; i++){
            var o1 = dataset.odds[i]
            var implied1 = parseFloat(o1.implied.replace("%", ""))
            var o2 = dataset.odds[i+1]
            var implied2 = parseFloat(o2.implied.replace("%", ""))
            
            // console.log(`${tmpProb} - ${implied1} - ${implied2}: ${(tmpProb >= implied1 && tmpProb < implied2)}`)
            if(tmpProb >= implied2 && tmpProb < implied1){
                return [o1, `${implied2}% - ${implied1}%`]
            }
        }
    }else{
        return [dataset.odds[0], `99% - 100%`]
    }
}

function applyParams() {
    if(dataset.player.p_1.name != undefined && dataset.player.p_2.name != undefined){
        var rating1 = getRating(dataset.player.p_1);
        var rating2 = getRating(dataset.player.p_2);

        var eloDiffH = fnEloDiff(parseFloat(rating1), parseFloat(rating2), "random")
        var eloDiff = eloDiffH.toFixed(0)
        var eScoreH = eloFn(eloDiffH)
        var eScore = eScoreH.toFixed(9);
        updateProbabilities(eScoreH, 0);
    }
}

// Use high-precision eScore and drawProb to avoid rounding issues.
/**
* NaN, 0
*/
function updateProbabilities(eScore, drawProb) {
	var scoreStr = "0-0"
	var parts = scoreStr.split("-");
	var s1 = 0;
	var s2 = 0;
	if (parts.length == 2) {
		s1 = parseFloat(parts[0]);
		s2 = parseFloat(parts[1]);
	}

	// var tournament = $("input[name=tournament]:checked").val();
	var tournament = "best-of"
	var probs;

	if (parts.length != 2)
		probs = ["(current score has wrong format)", "", ""];
	else if (tournament == "best-of") {
		// var n = parseInt($("input[name=best-of]").val());
		var n = 3
		var winProb = eScore - drawProb/2;
		probs = computeProbBestOf(n, winProb, drawProb, s1, s2);
	}
	else if (tournament == "margin") {
		if (drawProb == 0) {
			var n = parseInt($("input[name=margin]").val());
			probs = computeProbMargin(n, eScore, s1, s2);
		}
		else {
			probs = ["(margin-of-two with non-zero draw probability is not implemented)", "", ""];
		}
	
	}
	else
		probs = ["?", "?", "?"];

    const odds1 = findOdds(probs[0])
    const odds2 = findOdds(probs[1])

    $("#result_player_1 .probability").html(`<label class="mw-50px text-truncate" title="${probs[0]}">${probs[0]}</label>`);
    $("#result_player_1 .implied").html(`<span class="badge bg-secondary">${odds1[1]}</span>`);
    $("#result_player_1 .fraction").text(odds1[0].fraction);
    $("#result_player_1 .decimal").text(odds1[0].decimal);
    $("#result_player_1 .american").text(odds1[0].american);

    $("#result_player_2 .probability").html(`<label class="mw-50px text-truncate" title="${probs[1]}">${probs[1]}</label>`);
    $("#result_player_2 .implied").html(`<span class="badge bg-secondary">${odds2[1]}</span>`);
    $("#result_player_2 .fraction").text(odds2[0].fraction);
    $("#result_player_2 .decimal").text(odds2[0].decimal);
    $("#result_player_2 .american").text(odds2[0].american);
	// $("span#draw").text(probs[2]);
}

function computeProbBestOf(n, winProb, drawProb, s1, s2) {
	if (s1 * 2 != Math.floor(s1 * 2) || s2 * 2 != Math.floor(s2 * 2))
		return ["(current score is not composed of half-integers)", "", ""];
	if (s1 + s2 != Math.floor(s1 + s2))
		return ["(current score doesn't sum to an integer)", "", ""];
	if (isNaN(n) || isNaN(winProb) || isNaN(drawProb))
		return ["?", "?", "?"];
	if (s1 < 0 || s2 < 0)
		return ["(current score contains a negative number)", "", ""];
	if (s1 + s2 > n)
		return ["(current score sum exceeds match length)", "", ""];

	// Allocate. Tables are indexed by units of half-points.
	var winTable = [];
	var drawTable = [];
	for (var i = 0; i <= 2*n; i++) {
		winTable[i] = [];
		drawTable[i] = [];
	}

	// Boundary conditions.
	for (var i = 0; i <= 2*n; i++) {
		var j = 2*n - i;
		winTable[i][j] = (i > j ? 1 : 0);
		drawTable[i][j] = (i == j ? 1 : 0);
	}

	// Fill rest using recurrence.
	var loseProb = 1 - winProb - drawProb;
	for (var sum = n - 1; sum >= s1 + s2; sum--) {
		for (var i = 0; i <= 2*sum; i++) {
			var j = 2*sum - i;
			winTable[i][j] = winProb * winTable[i+2][j] +
			                 drawProb * winTable[i+1][j+1] +
			                 loseProb * winTable[i][j+2];
			drawTable[i][j] = winProb * drawTable[i+2][j] +
			                  drawProb * drawTable[i+1][j+1] +
			                  loseProb * drawTable[i][j+2];
		}
	}
	var win = winTable[s1*2][s2*2];
	var draw = drawTable[s1*2][s2*2];
	var lose = 1 - win - draw;

	// Prevent "-0.000000000" from being displayed.
	if (Math.abs(win) < 1e-10) win = 0;
	if (Math.abs(lose) < 1e-10) lose = 0;
	if (Math.abs(draw) < 1e-10) draw = 0;

	return [win.toFixed(9), lose.toFixed(9), draw.toFixed(9)];
}

function computeProbMargin(n, p, s1, s2) {
	if (s1 != Math.floor(s1) || s2 != Math.floor(s2))
		return ["(current score is not composed of integers)", "", ""];
	if (isNaN(n) || isNaN(p))
		return ["?", "?", "?"];
	if (s1 < 0 || s2 < 0)
		return ["(current score contains a negative number)", "", ""];

	var E = p*p / (1 - 2*(1-p)*p);	// Prob if equal.
	var A = (1 - (1-p)*p)/p * E;	// Prob if player1 advantage.
	var D = p * E;					// Prob if player1 disadvantage.

	var win;
	if (s1 > n || s2 > n) {
		var diff = s1 - s2;
		if (diff == 2)
			win = 1;
		else if (diff == 1)
			win = A;
		else if (diff == 0)
			win = E;
		else if (diff == -1)
			win = D;
		else if (diff == -2)
			win = 0;
		else
			return ["?", "?", "?"];
	}
	else {
		// Allocate.
		var winTable = [];
		for (var i = 0; i <= n; i++)
			winTable[i] = [];

		// Boundary conditions.
		for (var i = 0; i <= n-2; i++) {
			winTable[i][n] = 0;
			winTable[n][i] = 1;
		}
		winTable[n][n] = E;
		winTable[n][n-1] = A;
		winTable[n-1][n] = D;

		// Fill rest using recurrence.
		for (var i = n - 1; i >= s1; i--) {
			for (var j = n - 1; j >= s2; j--) {
				winTable[i][j] = p * winTable[i+1][j] +
			                	 (1 - p) * winTable[i][j+1];
			}
		}
		win = winTable[s1][s2];
	}

	var lose = 1 - win;
	var draw = 0;
	return [win.toFixed(9), lose.toFixed(9), draw.toFixed(9)];
}

function eloFn(eloDiff) {
	// var formula = $("input[name=formula]:checked").val();
	var formula = "logistic"
	return (formula == "normal") ?
	       eloNormal(eloDiff) : eloLogistic(eloDiff);
}
</script>

</html>